---
title: "Walmart Data Exploration"
date: "Sunday, November 08, 2015"
output: html_document
---

To start, the three separate tables that were provided in the Kaggle competition have been merged together into one table. Here's what the head of that table looks like:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# NOTE: If the following fails with "Error in file...", make sure to set the working director to the 
# directory where this file is found using `setwd()`
source('utility.R')
master <- get.master()
head(master)
```

### Data exploration and visualization

```{r, warning=FALSE, message=FALSE}
require(ggplot2)

get.grouped <- function(groups, filter=NULL){
  if(!is.null(filter)){
    df <- subset(master, master[,filter[1]] == filter[2])
  } else{
    df <- master
  }
  grouped <- ddply(df, groups, summarize, Sales=sum(Weekly_Sales), Norm_Sales=sum(Norm_Weekly_Sales))
  grouped$Sales_Millions <- grouped$Sales / 10e6
  return(grouped)
}

# trending over time
sales.by.week <- get.grouped(c('Date'))
labels <- labs(x='Week', y='Sales (millions)')
ggplot(data=sales.by.week, aes(x=Date, y=Sales_Millions)) + geom_line() + labels

# by store type
sales.by.type <- get.grouped(c('Store_Type','Date'))
ggplot(data=sales.by.type, aes(x=Date, y=Sales_Millions, group=Store_Type, color=Store_Type)) + geom_line() + labels

# by store (by type)
for (store.type in c('A', 'B', 'C')){
  sales.data <- get.grouped(c('Store', 'Date'), c('Store_Type', store.type))
  print(ggplot(data=sales.data, aes(x=Date, y=Sales_Millions, group=Store, color=Store)) + geom_line() + labels + labs(title=paste("Type", store.type, 'Store Sales by Store')) + guides(color=FALSE))
}
```

We can see that Type C stores are less impacted by the Holiday season than the other types of stores. We can also clearly see that most stores follow a similar seasonal patterns. Also, we see that some stores have Sales trending upward or downward over the span.

```{r}
sales.by.size <- get.grouped(c('Store', 'Store_Type', 'Store_Size'))
ggplot(data=sales.by.size, aes(x=Store_Size, y=Sales_Millions, color=Store_Type)) + 
  geom_point() + 
  labs(x='Store Size', y='Sales (millions)', title='Store Sales by Size & Type')
```

We see a clear relationship between increasing store size and increasing average store sales in this plot. We also see that the three store types are also closely associated with store sizes. Store type A generally equates to larger stores with higher sales volumes. Store type A has the smaller stores with smaller sales volumes. Store type B fits somewhere between A and C.

**External Factors**

How does unemployment relate to sales?

```{r}
# FIXME: need a better plot here
sales.by.unemployment <- get.grouped(c('Store', 'Date', 'Unemployment'))
ggplot(data=sales.by.unemployment, aes(x=Unemployment, y=Norm_Sales, color=Date)) + 
  geom_point() + 
  labs(x='Unemployment', y='Normalized Sales', title='Unemployment vs. Sales')
```

Relationships between temperature, fuel price, CPI, and unemployment. Consider normalizing temperature based on store location. Is the affect of temperature different based on the time of year?

TODO: calculate correlation between stores
TODO: do some of these trends impact some departments more than others
TODO: build a regression model
TODO: build a regression tree, random forest model
TODO: what's the distribution of weekly sales for a given store; is it normal? bimodal? long-tailed?
